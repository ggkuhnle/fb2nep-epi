<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>1.09 – Confounding, DAGs, and Causal Structure – FB2NEP Nutritional Epidemiology</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>
</head><body class="nav-sidebar floating nav-fixed"><img src="https://kuhnle.co.uk/pixel.png" width="1" height="1" style="display:none" alt="">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>





<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">FB2NEP Nutritional Epidemiology</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="../index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../assessment/index.html"> 
<span class="menu-text">Assessment</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">1.09 – Confounding, DAGs, and Causal Structure</li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">FB2NEP — Nutritional Epidemiology</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Notebooks</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
 <span class="menu-text">notebooks/*.ipynb</span>
  </li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Sandbox</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../howto_sandbox/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">FB2NEP — How‑To &amp; Sandbox (Colab/Jupyter)</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#association-and-causation" id="toc-association-and-causation" class="nav-link active" data-scroll-target="#association-and-causation"><span class="header-section-number">0.1</span> 1. Association and causation</a></li>
  <li><a href="#dags-for-model-development-and-identification-of-confounders-colliders-and-mediators" id="toc-dags-for-model-development-and-identification-of-confounders-colliders-and-mediators" class="nav-link" data-scroll-target="#dags-for-model-development-and-identification-of-confounders-colliders-and-mediators"><span class="header-section-number">0.2</span> 2. DAGs for model development and identification of confounders, colliders, and mediators</a>
  <ul class="collapse">
  <li><a href="#constructing-a-dag" id="toc-constructing-a-dag" class="nav-link" data-scroll-target="#constructing-a-dag"><span class="header-section-number">0.2.1</span> 2.1 Constructing a DAG</a></li>
  <li><a href="#why-we-do-not-include-everything" id="toc-why-we-do-not-include-everything" class="nav-link" data-scroll-target="#why-we-do-not-include-everything"><span class="header-section-number">0.2.2</span> 2.2 Why we do not include everything</a></li>
  </ul></li>
  <li><a href="#confounders" id="toc-confounders" class="nav-link" data-scroll-target="#confounders"><span class="header-section-number">0.3</span> 3. Confounders</a>
  <ul class="collapse">
  <li><a href="#definition-and-informal-examples" id="toc-definition-and-informal-examples" class="nav-link" data-scroll-target="#definition-and-informal-examples"><span class="header-section-number">0.3.1</span> 3.1 Definition and informal examples</a></li>
  <li><a href="#hippo-example-confounding" id="toc-hippo-example-confounding" class="nav-link" data-scroll-target="#hippo-example-confounding"><span class="header-section-number">0.3.2</span> Hippo example (confounding)</a></li>
  <li><a href="#approaches-to-adjustment" id="toc-approaches-to-adjustment" class="nav-link" data-scroll-target="#approaches-to-adjustment"><span class="header-section-number">0.3.3</span> 3.2 Approaches to adjustment</a></li>
  </ul></li>
  <li><a href="#example-physical-activity-ses-and-incident-cvd" id="toc-example-physical-activity-ses-and-incident-cvd" class="nav-link" data-scroll-target="#example-physical-activity-ses-and-incident-cvd"><span class="header-section-number">0.4</span> 3.3 Example: physical activity, SES, and incident CVD</a>
  <ul class="collapse">
  <li><a href="#interpreting-crude-vs-ses-adjusted-models-physical-activity" id="toc-interpreting-crude-vs-ses-adjusted-models-physical-activity" class="nav-link" data-scroll-target="#interpreting-crude-vs-ses-adjusted-models-physical-activity"><span class="header-section-number">0.4.1</span> Interpreting crude vs SES-adjusted models (physical activity)</a></li>
  <li><a href="#stratification-by-ses" id="toc-stratification-by-ses" class="nav-link" data-scroll-target="#stratification-by-ses"><span class="header-section-number">0.4.2</span> 3.4 Stratification by SES</a></li>
  <li><a href="#interpreting-the-ses-stratified-highpacvd-associations" id="toc-interpreting-the-ses-stratified-highpacvd-associations" class="nav-link" data-scroll-target="#interpreting-the-ses-stratified-highpacvd-associations"><span class="header-section-number">0.4.3</span> Interpreting the SES-stratified highPA–CVD associations</a></li>
  </ul></li>
  <li><a href="#special-case-energy-intake-in-nutritional-epidemiology" id="toc-special-case-energy-intake-in-nutritional-epidemiology" class="nav-link" data-scroll-target="#special-case-energy-intake-in-nutritional-epidemiology"><span class="header-section-number">0.5</span> 4. Special case: energy intake in nutritional epidemiology</a>
  <ul class="collapse">
  <li><a href="#why-total-energy-intake-is-different" id="toc-why-total-energy-intake-is-different" class="nav-link" data-scroll-target="#why-total-energy-intake-is-different"><span class="header-section-number">0.5.1</span> 4.1 Why total energy intake is different</a></li>
  <li><a href="#common-energy-adjustment-methods" id="toc-common-energy-adjustment-methods" class="nav-link" data-scroll-target="#common-energy-adjustment-methods"><span class="header-section-number">0.5.2</span> 4.2 Common energy-adjustment methods</a></li>
  <li><a href="#special-case-of-ffqs" id="toc-special-case-of-ffqs" class="nav-link" data-scroll-target="#special-case-of-ffqs"><span class="header-section-number">0.5.3</span> 4.3 Special case of FFQs</a></li>
  </ul></li>
  <li><a href="#colliders-and-mediators" id="toc-colliders-and-mediators" class="nav-link" data-scroll-target="#colliders-and-mediators"><span class="header-section-number">0.6</span> 5. Colliders and mediators</a>
  <ul class="collapse">
  <li><a href="#colliders" id="toc-colliders" class="nav-link" data-scroll-target="#colliders"><span class="header-section-number">0.6.1</span> 5.1 Colliders</a></li>
  <li><a href="#mediators" id="toc-mediators" class="nav-link" data-scroll-target="#mediators"><span class="header-section-number">0.6.2</span> 5.2 Mediators</a></li>
  <li><a href="#example-of-mediation-salt-sbp-and-incident-cvd" id="toc-example-of-mediation-salt-sbp-and-incident-cvd" class="nav-link" data-scroll-target="#example-of-mediation-salt-sbp-and-incident-cvd"><span class="header-section-number">0.6.3</span> 5.3 Example of mediation: salt, SBP, and incident CVD</a></li>
  <li><a href="#interpreting-the-mediation-example-salt-and-sbp" id="toc-interpreting-the-mediation-example-salt-and-sbp" class="nav-link" data-scroll-target="#interpreting-the-mediation-example-salt-and-sbp"><span class="header-section-number">0.6.4</span> Interpreting the mediation example (salt and SBP)</a></li>
  <li><a href="#predicted-probability-of-incident-cvd-across-salt-intake" id="toc-predicted-probability-of-incident-cvd-across-salt-intake" class="nav-link" data-scroll-target="#predicted-probability-of-incident-cvd-across-salt-intake"><span class="header-section-number">0.6.5</span> 5.4 Predicted probability of incident CVD across salt intake</a></li>
  <li><a href="#interpreting-the-predicted-probability-curve-salt-sbp-fixed" id="toc-interpreting-the-predicted-probability-curve-salt-sbp-fixed" class="nav-link" data-scroll-target="#interpreting-the-predicted-probability-curve-salt-sbp-fixed"><span class="header-section-number">0.6.6</span> Interpreting the predicted probability curve (salt, SBP fixed)</a></li>
  </ul></li>
  <li><a href="#interaction-and-effect-modification" id="toc-interaction-and-effect-modification" class="nav-link" data-scroll-target="#interaction-and-effect-modification"><span class="header-section-number">0.7</span> 6. Interaction and effect modification</a></li>
  <li><a href="#interpreting-an-interaction-term-in-logistic-regression" id="toc-interpreting-an-interaction-term-in-logistic-regression" class="nav-link" data-scroll-target="#interpreting-an-interaction-term-in-logistic-regression"><span class="header-section-number">1</span> Interpreting an Interaction Term in Logistic Regression</a>
  <ul class="collapse">
  <li><a href="#high-physical-activity-socio-economic-status" id="toc-high-physical-activity-socio-economic-status" class="nav-link" data-scroll-target="#high-physical-activity-socio-economic-status"><span class="header-section-number">1.0.1</span> (High Physical Activity × Socio-Economic Status)</a></li>
  <li><a href="#what-an-interaction-term-represents" id="toc-what-an-interaction-term-represents" class="nav-link" data-scroll-target="#what-an-interaction-term-represents"><span class="header-section-number">1.1</span> 1. What an interaction term represents</a></li>
  <li><a href="#how-to-read-the-interaction-coefficient" id="toc-how-to-read-the-interaction-coefficient" class="nav-link" data-scroll-target="#how-to-read-the-interaction-coefficient"><span class="header-section-number">1.2</span> 2. How to read the interaction coefficient</a></li>
  <li><a href="#how-the-interaction-affects-group-specific-effects" id="toc-how-the-interaction-affects-group-specific-effects" class="nav-link" data-scroll-target="#how-the-interaction-affects-group-specific-effects"><span class="header-section-number">1.3</span> 3. How the interaction affects group-specific effects</a></li>
  <li><a href="#confidence-intervals-and-interpretation" id="toc-confidence-intervals-and-interpretation" class="nav-link" data-scroll-target="#confidence-intervals-and-interpretation"><span class="header-section-number">1.4</span> 4. Confidence intervals and interpretation</a></li>
  <li><a href="#practical-takeaway-for-applied-epidemiology" id="toc-practical-takeaway-for-applied-epidemiology" class="nav-link" data-scroll-target="#practical-takeaway-for-applied-epidemiology"><span class="header-section-number">1.5</span> 5. Practical takeaway for applied epidemiology</a></li>
  <li><a href="#counterfactuals" id="toc-counterfactuals" class="nav-link" data-scroll-target="#counterfactuals"><span class="header-section-number">1.6</span> 7. Counterfactuals</a></li>
  <li><a href="#reflection-and-exercises" id="toc-reflection-and-exercises" class="nav-link" data-scroll-target="#reflection-and-exercises"><span class="header-section-number">1.7</span> Reflection and exercises</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/ggkuhnle/fb2nep-epi/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li><li><a href="https://github.com/ggkuhnle/fb2nep-epi/blob/main/notebooks/1.09_regression_modelling_02.ipynb" class="toc-action"><i class="bi empty"></i>View source</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">1.09 – Confounding, DAGs, and Causal Structure</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Version 0.0.6</p>
<p>This workbook builds on Workbook 6.</p>
<p>In Workbook 6, we treated regression as a practical tool for estimating associations between an exposure and an outcome, and we focused on model types (linear, logistic, Cox), assumptions, diagnostics, and basic interpretation of coefficients (β, OR, RR, HR).</p>
<p>In this workbook, we move from <strong>association</strong> to <strong>causal thinking</strong>. We introduce:</p>
<ul>
<li>Confounders.</li>
<li>Colliders.</li>
<li>Mediators.</li>
<li>Directed acyclic graphs (DAGs) as a way to formalise causal assumptions.</li>
<li>Approaches to adjustment (stratification and regression).</li>
<li>The special role of <strong>energy intake</strong> in nutritional epidemiology.</li>
<li>A brief introduction to <strong>counterfactual</strong> thinking.</li>
</ul>
<p>A more formal treatment of causal inference, including modern notation and methods, is given in <strong>Workbook 9</strong>. Here we focus on intuition and on how causal structure affects regression analyses in practice.</p>
<p>We will use the synthetic <em>FB2NEP cohort</em> throughout. The precise variable names may differ slightly from those used here; if you obtain an error (for example, <code>KeyError</code>), carefully check the column names of the dataset and adapt the code accordingly.</p>
<div id="bootstrap_fb2nep_7" class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># FB2NEP bootstrap cell (works both locally and in Colab)</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># What this cell does:</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># - Ensures that we are inside the fb2nep-epi repository.</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># - In Colab: clones the repository from GitHub if necessary.</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># - Loads and runs scripts/bootstrap.py.</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># - Makes the main dataset available as the variable `df`.</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Important:</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># - You may see messages printed below (for example from pip</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">#   or from the bootstrap script). This is expected.</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># - You may also see WARNINGS (often in yellow). In most cases</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co">#   these are harmless and can be ignored for this module.</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># - The main thing to watch for is a red error traceback</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co">#   (for example FileNotFoundError, ModuleNotFoundError).</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co">#   If that happens, please re-run this cell first. If the</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co">#   error persists, ask for help.</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pathlib</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> importlib.util</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Configuration: repository location and URL</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co"># REPO_URL: address of the GitHub repository.</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="co"># REPO_DIR: folder name that will be created when cloning.</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>REPO_URL <span class="op">=</span> <span class="st">"https://github.com/ggkuhnle/fb2nep-epi.git"</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>REPO_DIR <span class="op">=</span> <span class="st">"fb2nep-epi"</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Ensure we are inside the fb2nep-epi repository</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="co"># In local Jupyter, you may already be inside the repository,</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="co"># for example in fb2nep-epi/notebooks.</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="co"># In Colab, the default working directory is /content, so</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="co"># we need to clone the repository into /content/fb2nep-epi</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="co"># and then change into that folder.</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>cwd <span class="op">=</span> pathlib.Path.cwd()</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Case A: we are already in the repository (scripts/bootstrap.py exists here)</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (cwd <span class="op">/</span> <span class="st">"scripts"</span> <span class="op">/</span> <span class="st">"bootstrap.py"</span>).is_file():</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>    repo_root <span class="op">=</span> cwd</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Case B: we are outside the repository (for example in Colab)</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>    repo_root <span class="op">=</span> cwd <span class="op">/</span> REPO_DIR</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clone the repository if it is not present yet</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> repo_root.is_dir():</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Cloning repository from </span><span class="sc">{</span>REPO_URL<span class="sc">}</span><span class="ss"> into </span><span class="sc">{</span>repo_root<span class="sc">}</span><span class="ss"> ..."</span>)</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>        subprocess.run([<span class="st">"git"</span>, <span class="st">"clone"</span>, REPO_URL, <span class="bu">str</span>(repo_root)], check<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Using existing repository at </span><span class="sc">{</span>repo_root<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Change the working directory to the repository root</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>    os.chdir(repo_root)</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>    repo_root <span class="op">=</span> pathlib.Path.cwd()</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Repository root set to: </span><span class="sc">{</span>repo_root<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Load scripts/bootstrap.py as a module and call init()</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a><span class="co"># The shared bootstrap script contains all logic to:</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a><span class="co"># - Ensure that required Python packages are installed.</span></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a><span class="co"># - Ensure that the synthetic dataset exists (and generate it</span></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a><span class="co">#   if needed).</span></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a><span class="co"># - Load the dataset into a pandas DataFrame.</span></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a><span class="co"># We load the script as a normal Python module (fb2nep_bootstrap)</span></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a><span class="co"># and then call its init() function.</span></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>bootstrap_path <span class="op">=</span> repo_root <span class="op">/</span> <span class="st">"scripts"</span> <span class="op">/</span> <span class="st">"bootstrap.py"</span></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> bootstrap_path.is_file():</span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"Could not find </span><span class="sc">{</span>bootstrap_path<span class="sc">}</span><span class="ss">. "</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Please check that the fb2nep-epi repository structure is intact."</span></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a module specification from the file</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>spec <span class="op">=</span> importlib.util.spec_from_file_location(<span class="st">"fb2nep_bootstrap"</span>, bootstrap_path)</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>bootstrap <span class="op">=</span> importlib.util.module_from_spec(spec)</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>sys.modules[<span class="st">"fb2nep_bootstrap"</span>] <span class="op">=</span> bootstrap</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a><span class="co"># Execute the bootstrap script in the context of this module</span></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>spec.loader.exec_module(bootstrap)</span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a><span class="co"># The init() function is defined in scripts/bootstrap.py.</span></span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a><span class="co"># It returns:</span></span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a><span class="co"># - df   : the main synthetic cohort as a pandas DataFrame.</span></span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a><span class="co"># - CTX  : a small context object with paths, flags and settings.</span></span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>df, CTX <span class="op">=</span> bootstrap.init()</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a><span class="co"># Optionally expose a few additional useful variables from the</span></span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a><span class="co"># bootstrap module (if they exist). These are not essential for</span></span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a><span class="co"># most analyses, but can be helpful for advanced use.</span></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> [<span class="st">"CSV_REL"</span>, <span class="st">"REPO_NAME"</span>, <span class="st">"REPO_URL"</span>, <span class="st">"IN_COLAB"</span>]:</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(bootstrap, name):</span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>        <span class="bu">globals</span>()[name] <span class="op">=</span> <span class="bu">getattr</span>(bootstrap, name)</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Bootstrap completed successfully."</span>)</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"The main dataset is available as the variable `df`."</span>)</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"The context object is available as `CTX`."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="imports_fb2nep_7" class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">Imports and quick inspection</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">============================</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">In this cell we:</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">- Import common packages used in this workbook.</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">- Display basic information about the dataset to confirm that it is loaded.</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">The imports are deliberately explicit. Many students using this workbook</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">will not yet have much experience with Python, so we avoid implicit</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">magic and keep the code readable.</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.formula.api <span class="im">as</span> smf</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> norm</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scripts.helpers_tables <span class="im">import</span> or_from_linear_combination</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"DataFrame shape (rows, columns):"</span>, df.shape)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">First five rows of the dataset:"</span>)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>display(df.head())</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Variable types (first 20 columns):"</span>)</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>display(df.dtypes.head(<span class="dv">20</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="association-and-causation" class="level2" data-number="0.1">
<h2 data-number="0.1" class="anchored" data-anchor-id="association-and-causation"><span class="header-section-number">0.1</span> 1. Association and causation</h2>
<p>Regression models (linear, logistic, Cox) quantify <strong>associations</strong>:</p>
<ul>
<li>In linear regression, a coefficient describes how the <em>mean</em> outcome changes with the exposure.</li>
<li>In logistic regression, we obtain <em>odds ratios</em>.</li>
<li>In Cox regression, we obtain <em>hazard ratios</em>.</li>
</ul>
<p>However, public health decisions concern <strong>causal effects</strong>:</p>
<blockquote class="blockquote">
<p><em>If we changed this exposure (for example, salt intake), what would happen to the outcome?</em></p>
</blockquote>
<p>In observational data, a non-zero regression coefficient does <strong>not</strong> automatically imply a causal effect. Several types of variables can distort or create associations:</p>
<ul>
<li><strong>Confounders</strong>: common causes of exposure and outcome that, if unadjusted, bias estimated effects.</li>
<li><strong>Colliders</strong>: variables that are caused by two other variables; conditioning on them can create spurious associations.</li>
<li><strong>Mediators</strong>: variables lying <em>on</em> the causal pathway; adjusting for them can remove part of a genuine effect.</li>
</ul>
<p>To move from association to causation we need to consider the <strong>causal structure</strong> of the variables. In this workbook we introduce DAGs and basic adjustment strategies. Workbook 9 provides a more formal framework for causal inference.</p>
</section>
<section id="dags-for-model-development-and-identification-of-confounders-colliders-and-mediators" class="level2" data-number="0.2">
<h2 data-number="0.2" class="anchored" data-anchor-id="dags-for-model-development-and-identification-of-confounders-colliders-and-mediators"><span class="header-section-number">0.2</span> 2. DAGs for model development and identification of confounders, colliders, and mediators</h2>
<p>A <strong>directed acyclic graph (DAG)</strong> is a diagram with arrows that represents assumptions about which variables cause which. It is:</p>
<ul>
<li><strong>Directed</strong>: arrows have a direction (cause → effect).</li>
<li><strong>Acyclic</strong>: there are no feedback loops.</li>
</ul>
<p>DAGs are useful because they make assumptions <strong>explicit</strong> and allow us to reason about which variables we should adjust for in regression models.</p>
<section id="constructing-a-dag" class="level3" data-number="0.2.1">
<h3 data-number="0.2.1" class="anchored" data-anchor-id="constructing-a-dag"><span class="header-section-number">0.2.1</span> 2.1 Constructing a DAG</h3>
<p>To construct a DAG for a research question:</p>
<ol type="1">
<li><strong>List key variables</strong>
<ul>
<li>Exposure (for example, red meat intake).</li>
<li>Outcome (for example, incident cancer).</li>
<li>Plausible causes of exposure and outcome (for example, socio-economic status, age, smoking).</li>
</ul></li>
<li><strong>Draw arrows according to subject-matter knowledge</strong>
<ul>
<li>If variable A can plausibly influence variable B, draw <code>A → B</code>.</li>
<li>Do <strong>not</strong> add arrows simply because two variables are correlated in the data.</li>
</ul></li>
<li><strong>Identify paths between exposure and outcome</strong>
<ul>
<li>Causal paths (exposure → … → outcome).</li>
<li>Non-causal “backdoor” paths (exposure ← … → outcome) that create confounding.</li>
</ul></li>
<li><strong>Decide on an adjustment set</strong>
<ul>
<li>Choose variables to adjust for so that all non-causal backdoor paths are blocked, without conditioning on colliders or mediators.</li>
</ul></li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../_assets/epi_dag.png" class="img-fluid figure-img"></p>
<figcaption>DAG</figcaption>
</figure>
</div>
</section>
<section id="why-we-do-not-include-everything" class="level3" data-number="0.2.2">
<h3 data-number="0.2.2" class="anchored" data-anchor-id="why-we-do-not-include-everything"><span class="header-section-number">0.2.2</span> 2.2 Why we do not include everything</h3>
<p>It might be tempting to adjust for <strong>every available variable</strong>. This is usually a bad idea because:</p>
<ul>
<li>Adjusting for <strong>colliders</strong> can <em>create</em> bias.</li>
<li>Adjusting for <strong>mediators</strong> can remove part of the effect we are interested in (for example, when estimating the total effect of an exposure).</li>
<li>Adjusting for variables that are neither confounders nor mediators can increase variance and complicate interpretation without reducing bias.</li>
</ul>
<p>A good DAG includes <strong>enough</strong> variables to capture the main causal structure, but not every variable in the dataset. We use subject-matter knowledge and parsimony: include variables that are plausible causes of exposure and outcome, and that are important for the research question.</p>
</section>
</section>
<section id="confounders" class="level2" data-number="0.3">
<h2 data-number="0.3" class="anchored" data-anchor-id="confounders"><span class="header-section-number">0.3</span> 3. Confounders</h2>
<section id="definition-and-informal-examples" class="level3" data-number="0.3.1">
<h3 data-number="0.3.1" class="anchored" data-anchor-id="definition-and-informal-examples"><span class="header-section-number">0.3.1</span> 3.1 Definition and informal examples</h3>
<p>A variable is a <strong>confounder</strong> for the association between an exposure and an outcome if:</p>
<ol type="1">
<li>It is associated with the exposure.</li>
<li>It is a cause of, or associated with a cause of, the outcome.</li>
<li>It is not on the causal pathway from exposure to outcome.</li>
</ol>
<p>Intuitively, a confounder is a variable that makes exposed and unexposed individuals systematically different, in a way that also affects the outcome.</p>
<p>Classic informal examples include:</p>
<ul>
<li><p><strong>Number of children and BRCA risk</strong>: women with more children tend to be older, and age affects the probability of having developed breast cancer; age can confound the association between “number of children” and “current breast cancer status”.</p></li>
<li><p><strong>Hair length and income</strong>: there may appear to be an association between hair length and income if, in a given setting, women tend to have longer hair than men and also have different average incomes; sex is a confounder.</p></li>
</ul>
</section>
<section id="hippo-example-confounding" class="level3" data-number="0.3.2">
<h3 data-number="0.3.2" class="anchored" data-anchor-id="hippo-example-confounding"><span class="header-section-number">0.3.2</span> Hippo example (confounding)</h3>
<p><strong>Hippo size and daily grass intake</strong></p>
<p>Suppose we observe that <em>larger hippos eat more grass per day</em>.<br>
We might be tempted to conclude that <strong>being large makes hippos eat more</strong>.</p>
<p>But consider the underlying biology:</p>
<ul>
<li>Older hippos tend to be larger (simply through growth).</li>
<li>Older hippos also spend more hours grazing because they no longer play in the water as much as juveniles.</li>
</ul>
<p><strong>Age</strong> is therefore a confounder:</p>
<pre class="text"><code>       age
      /    \
 hippo size  grass intake</code></pre>
<p>In causal terms:</p>
<p>Size ← Age → Grass intake</p>
<p>If we ignore age, the association between hippo size and grass intake partly reflects the fact that older hippos both weigh more and eat more, not necessarily that body size itself increases grazing behaviour.</p>
</section>
<section id="approaches-to-adjustment" class="level3" data-number="0.3.3">
<h3 data-number="0.3.3" class="anchored" data-anchor-id="approaches-to-adjustment"><span class="header-section-number">0.3.3</span> 3.2 Approaches to adjustment</h3>
<p>There are two basic ways to adjust for confounders:</p>
<ul>
<li><strong>Stratification</strong>
<ul>
<li>Analyse the exposure–outcome association <em>within levels</em> of the confounder.</li>
<li>For example, estimate the association separately in high and low socio-economic status (SES) groups.</li>
</ul></li>
<li><strong>Inclusion in a regression model</strong>
<ul>
<li>Include the confounder as a <strong>covariate</strong> (predictor) in the regression model.</li>
<li>For a linear model: <span class="math display">\[
Y = \beta_0 + \beta_1 X + \beta_2 C + \varepsilon,
\]</span> where $ X $ is the exposure and $ C $ is the confounder.</li>
<li>The coefficient $ _1 $ is then interpreted as the association between $ X $ and $ Y $ <strong>for individuals with the same value of $ C $</strong>.</li>
</ul></li>
</ul>
<p>In practice, regression models with appropriate covariates are the most common approach, but stratified analyses are useful for checking assumptions and for illustrating confounding.</p>
<p>In the next section we use the FB2NEP cohort to demonstrate confounding in a setting where the data-generating mechanism includes known confounders.</p>
</section>
</section>
<section id="example-physical-activity-ses-and-incident-cvd" class="level2" data-number="0.4">
<h2 data-number="0.4" class="anchored" data-anchor-id="example-physical-activity-ses-and-incident-cvd"><span class="header-section-number">0.4</span> 3.3 Example: physical activity, SES, and incident CVD</h2>
<p>We now consider a concrete example using the FB2NEP cohort.</p>
<ul>
<li><strong>Exposure</strong>: physical activity (<code>physical_activity</code>).</li>
<li><strong>Outcome</strong>: incident cardiovascular disease during follow-up (<code>CVD_incident</code>).</li>
<li><strong>Potential confounder</strong>: socio-economic status (<code>SES_class</code>).</li>
</ul>
<p>From the data generator we know that:</p>
<ul>
<li>Physical activity (<code>physical_activity</code>) is socially patterned: higher SES and less deprivation are associated with higher activity.</li>
<li>CVD risk is affected by several factors related to SES (for example, smoking, SBP, BMI, diet).</li>
</ul>
<p>A simplified DAG is:</p>
<pre class="text"><code>SES_class  →  physical_activity
SES_class  →  CVD_incident
physical_activity  →  CVD_incident   (modest protective effect)</code></pre>
<p>Here, <code>SES_class</code> is a <strong>confounder</strong>: it influences both physical activity and CVD. If we estimate the association between physical activity and CVD <strong>without</strong> adjusting for SES, the result may be biased. We therefore:</p>
<ol type="1">
<li>Create a binary indicator of “high” physical activity.</li>
<li>Fit a crude logistic regression model of CVD on high activity.</li>
<li>Fit an SES-adjusted model.</li>
<li>Compare the results and repeat the analysis stratified by SES.</li>
</ol>
<div id="confounders_demo_pa_fb2nep_7" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scripts.helpers_tables <span class="im">import</span> summarise_logit_coef</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>OUTCOME_VAR <span class="op">=</span> <span class="st">"CVD_incident"</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>EXPOSURE_RAW <span class="op">=</span> <span class="st">"physical_activity"</span>      <span class="co"># categorical: low / moderate / high</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>CONF_VAR <span class="op">=</span> <span class="st">"SES_class"</span>                  <span class="co"># ABC1 / C2DE</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Check variables and prepare analysis dataset</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> v <span class="kw">in</span> [OUTCOME_VAR, EXPOSURE_RAW, CONF_VAR]:</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> v <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">KeyError</span>(</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"Variable '</span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">' not found in df. "</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"Available columns (first 20): </span><span class="sc">{</span><span class="bu">list</span>(df.columns)[:<span class="dv">20</span>]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co"># We define high physical activity as the exposure of interest</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>df_pa <span class="op">=</span> df[[OUTCOME_VAR, EXPOSURE_RAW, CONF_VAR]].dropna().copy()</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>df_pa[<span class="st">"highPA"</span>] <span class="op">=</span> (df_pa[EXPOSURE_RAW] <span class="op">==</span> <span class="st">"high"</span>).astype(<span class="bu">int</span>)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Complete-case sample size: </span><span class="sc">{</span>df_pa<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> observations</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Distribution of physical_activity and SES_class:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>display(pd.crosstab(df_pa[EXPOSURE_RAW], df_pa[CONF_VAR], normalize<span class="op">=</span><span class="st">"columns"</span>))</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Crude and SES-adjusted logistic regression models</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>formula_crude <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>OUTCOME_VAR<span class="sc">}</span><span class="ss"> ~ highPA"</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>formula_adj   <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>OUTCOME_VAR<span class="sc">}</span><span class="ss"> ~ highPA + C(</span><span class="sc">{</span>CONF_VAR<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>m_crude <span class="op">=</span> smf.logit(formula_crude, data<span class="op">=</span>df_pa).fit(disp<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>m_adj   <span class="op">=</span> smf.logit(formula_adj,   data<span class="op">=</span>df_pa).fit(disp<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>rows <span class="op">=</span> []</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>rows.append(</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>    summarise_logit_coef(</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>        m_crude,</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>        var_name<span class="op">=</span><span class="st">"highPA"</span>,</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">"Crude model (no SES adjustment)"</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>rows.append(</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>    summarise_logit_coef(</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>        m_adj,</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>        var_name<span class="op">=</span><span class="st">"highPA"</span>,</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">"Adjusted model (including SES_class)"</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>summary_pa <span class="op">=</span> pd.DataFrame(rows)</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">High physical activity vs incident CVD: crude and SES-adjusted models</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>display(summary_pa.<span class="bu">round</span>(<span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="interpreting-crude-vs-ses-adjusted-models-physical-activity" class="level3" data-number="0.4.1">
<h3 data-number="0.4.1" class="anchored" data-anchor-id="interpreting-crude-vs-ses-adjusted-models-physical-activity"><span class="header-section-number">0.4.1</span> Interpreting crude vs SES-adjusted models (physical activity)</h3>
<p>The table summarises the association between <strong>high physical activity</strong> (<code>highPA</code>) and incident CVD:</p>
<ul>
<li>The <strong>crude model</strong> compares high vs non-high physical activity without adjustment for SES.</li>
<li>The <strong>adjusted model</strong> includes <code>SES_class</code> as a covariate.</li>
</ul>
<p>Typical patterns to look for:</p>
<ul>
<li>If high physical activity is genuinely protective, you might expect an OR &lt; 1.</li>
<li>Because SES is associated with both physical activity and CVD, failing to adjust for SES can bias the crude OR towards or away from 1.</li>
</ul>
<p>In this synthetic cohort you will usually find that:</p>
<ul>
<li>The <strong>crude OR</strong> for <code>highPA</code> is only modestly below 1 (weak protective effect).</li>
<li>The <strong>SES-adjusted OR</strong> is somewhat further from 1 (stronger apparent protection).</li>
</ul>
<p>This is consistent with <strong>positive confounding</strong>: high SES participants tend to be more physically active <em>and</em> at lower CVD risk for other reasons. When SES is left unadjusted, part of this benefit is incorrectly attributed to physical activity. Once SES is included in the model, the association for <code>highPA</code> more closely reflects the effect of physical activity <em>for individuals with the same SES</em>.</p>
</section>
<section id="stratification-by-ses" class="level3" data-number="0.4.2">
<h3 data-number="0.4.2" class="anchored" data-anchor-id="stratification-by-ses"><span class="header-section-number">0.4.2</span> 3.4 Stratification by SES</h3>
<p>Regression adjustment is one way to account for confounding. Another is to analyse the exposure–outcome association <strong>within strata</strong> of the confounder.</p>
<p>Here we:</p>
<ol type="1">
<li>Split the data into two strata: <code>SES_class = ABC1</code> and <code>SES_class = C2DE</code>.</li>
<li>In each stratum, fit a logistic regression model: CVD_incident ~ highPA</li>
<li>Compare the stratum-specific odds ratios.</li>
</ol>
<p>If SES is a confounder rather than an effect modifier, we would expect the stratum-specific ORs for <code>highPA</code> to be <strong>more similar</strong> to each other and to the SES-adjusted OR, and different from the crude OR.</p>
<div id="stratification_pa_code_fb2nep_7" class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">"""Stratified analysis: highPA and CVD_incident within SES strata."""</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>rows_strata <span class="op">=</span> []</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Stratified analyses by SES_class (separate models in each stratum):</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> level <span class="kw">in</span> <span class="bu">sorted</span>(df_pa[CONF_VAR].unique()):</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    df_stratum <span class="op">=</span> df_pa[df_pa[CONF_VAR] <span class="op">==</span> level]</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Stratum </span><span class="sc">{</span>level<span class="sc">}</span><span class="ss">: n = </span><span class="sc">{</span>df_stratum<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Need variation in exposure and outcome</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> df_stratum[OUTCOME_VAR].nunique() <span class="op">&lt;</span> <span class="dv">2</span> <span class="kw">or</span> df_stratum[<span class="st">"highPA"</span>].nunique() <span class="op">&lt;</span> <span class="dv">2</span>:</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"    Not enough variation in outcome or exposure for logistic regression.</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    m_stratum <span class="op">=</span> smf.logit(<span class="ss">f"</span><span class="sc">{</span>OUTCOME_VAR<span class="sc">}</span><span class="ss"> ~ highPA"</span>, data<span class="op">=</span>df_stratum).fit(disp<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    rows_strata.append(</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        summarise_logit_coef(</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>            m_stratum,</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>            var_name<span class="op">=</span><span class="st">"highPA"</span>,</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="ss">f"SES_class = </span><span class="sc">{</span>level<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> rows_strata:</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    summary_strata_pa <span class="op">=</span> pd.DataFrame(rows_strata)</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Stratum-specific odds ratios for highPA (by SES_class):</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    display(summary_strata_pa.<span class="bu">round</span>(<span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="interpreting-the-ses-stratified-highpacvd-associations" class="level3" data-number="0.4.3">
<h3 data-number="0.4.3" class="anchored" data-anchor-id="interpreting-the-ses-stratified-highpacvd-associations"><span class="header-section-number">0.4.3</span> Interpreting the SES-stratified highPA–CVD associations</h3>
<p>The table above shows the association between high physical activity (<code>highPA</code>) and incident CVD within strata of socio-economic status (<code>SES_class</code>):</p>
<ul>
<li><strong>ABC1</strong>
<ul>
<li>OR ≈ 1.05 (95 % CI 0.91 to 1.20), p ≈ 0.52<br>
</li>
<li>Point estimate slightly <strong>above</strong> 1.0, but the confidence interval is wide and clearly includes 1.0 → compatible with no association.</li>
</ul></li>
<li><strong>C2DE</strong>
<ul>
<li>OR ≈ 0.89 (95 % CI 0.76 to 1.03), p ≈ 0.11<br>
</li>
<li>Point estimate slightly <strong>below</strong> 1.0, again with a confidence interval that includes 1.0 → also compatible with no association.</li>
</ul></li>
</ul>
<p>A few points to emphasise:</p>
<ul>
<li><p>The <strong>effect sizes are small</strong> in both strata, and statistically weak.<br>
There is no strong evidence that high physical activity is clearly protective or clearly harmful for CVD in either SES group in this synthetic cohort.</p></li>
<li><p>The <strong>directions differ</strong> slightly (OR &gt; 1 in ABC1, OR &lt; 1 in C2DE), but the confidence intervals are wide and largely overlapping. This means that the apparent difference between strata is easily explained by <strong>random variation</strong>.</p></li>
<li><p>As a worked example, this is closer to “what often happens in practice” than to a textbook Simpson’s paradox:<br>
adjusting or stratifying can change effect estimates a little, but not every plausible confounder produces a dramatic shift.</p></li>
</ul>
<p>For here, key messages are:</p>
<ul>
<li>Do not over-interpret small differences in odds ratios when confidence intervals are wide and overlapping.</li>
<li>Stratified analyses are still useful: they make us <strong>look</strong> at whether the exposure–outcome association is similar across subgroups, and they remind us that confounding and effect modification are empirical questions, not assumptions built into the model.</li>
</ul>
</section>
</section>
<section id="special-case-energy-intake-in-nutritional-epidemiology" class="level2" data-number="0.5">
<h2 data-number="0.5" class="anchored" data-anchor-id="special-case-energy-intake-in-nutritional-epidemiology"><span class="header-section-number">0.5</span> 4. Special case: energy intake in nutritional epidemiology</h2>
<section id="why-total-energy-intake-is-different" class="level3" data-number="0.5.1">
<h3 data-number="0.5.1" class="anchored" data-anchor-id="why-total-energy-intake-is-different"><span class="header-section-number">0.5.1</span> 4.1 Why total energy intake is different</h3>
<p>In nutritional epidemiology, <strong>total energy intake</strong> (for example, <code>energy_kcal</code>) is not a classical confounder in the usual sense. Instead, it is a kind of “scaling” variable:</p>
<ul>
<li>Individuals who eat <strong>more total energy</strong> tend to consume more of many nutrients and foods simply because they eat more food.</li>
<li>Many nutrients are also biologically related to energy intake (for example, higher energy intake is often associated with higher body size and physical activity).</li>
</ul>
<p>If we ignore total energy intake, we may incorrectly attribute the effect of “eating more food overall” to a specific nutrient or food.</p>
</section>
<section id="common-energy-adjustment-methods" class="level3" data-number="0.5.2">
<h3 data-number="0.5.2" class="anchored" data-anchor-id="common-energy-adjustment-methods"><span class="header-section-number">0.5.2</span> 4.2 Common energy-adjustment methods</h3>
<p>Several approaches are used to adjust nutrient intakes for total energy:</p>
<ol type="1">
<li><strong>Nutrient density method</strong>
<ul>
<li>Express the nutrient per unit of energy, for example g/MJ or % of energy.</li>
<li>Example: grams of fibre per 10 MJ.</li>
</ul></li>
<li><strong>Residual method</strong>
<ul>
<li>Regress the nutrient of interest on total energy intake.</li>
<li>Use the <strong>residuals</strong> (observed minus expected nutrient intake given energy) as an energy-adjusted exposure.</li>
<li>This removes the part of the nutrient intake that is explained by total energy intake.</li>
</ul></li>
<li><strong>Energy-adjusted models</strong>
<ul>
<li>Include both the nutrient and total energy intake as covariates in the regression model of interest.</li>
</ul></li>
</ol>
<p>Each method has advantages and disadvantages. The residual method and energy-adjusted models are particularly useful when working with food-frequency questionnaires (FFQs), where measurement error and strong correlations between nutrients can be substantial.</p>
</section>
<section id="special-case-of-ffqs" class="level3" data-number="0.5.3">
<h3 data-number="0.5.3" class="anchored" data-anchor-id="special-case-of-ffqs"><span class="header-section-number">0.5.3</span> 4.3 Special case of FFQs</h3>
<p>FFQs typically record <strong>relative</strong> frequencies of consumption over long periods. Reported intakes of many foods and nutrients are highly correlated, and systematic measurement error is common. Adjusting for total energy intake can:</p>
<ul>
<li>Reduce measurement error that is common to many foods (for example, general over-reporting or under-reporting).</li>
<li>Focus analyses on <strong>diet composition</strong> rather than total amount of food.</li>
</ul>
</section>
</section>
<section id="colliders-and-mediators" class="level2" data-number="0.6">
<h2 data-number="0.6" class="anchored" data-anchor-id="colliders-and-mediators"><span class="header-section-number">0.6</span> 5. Colliders and mediators</h2>
<section id="colliders" class="level3" data-number="0.6.1">
<h3 data-number="0.6.1" class="anchored" data-anchor-id="colliders"><span class="header-section-number">0.6.1</span> 5.1 Colliders</h3>
<p>A <strong>collider</strong> is a variable that is <em>caused</em> by two (or more) other variables. In a simple diagram:</p>
<pre class="text"><code>exercise  →
            fitness
genes     →</code></pre>
<p>Here, <code>fitness</code> is a collider on the path between <code>exercise</code> and <code>genes</code>. If we <strong>condition</strong> on fitness (for example, by restricting the analysis to individuals with high fitness, or adjusting for fitness in a model), we can induce an association between exercise and genes even if none exists in the population.</p>
<p>This is known as <strong>collider bias</strong> or <strong>selection bias</strong> when the collider is related to being included in the study.</p>
</section>
<section id="mediators" class="level3" data-number="0.6.2">
<h3 data-number="0.6.2" class="anchored" data-anchor-id="mediators"><span class="header-section-number">0.6.2</span> 5.2 Mediators</h3>
<p>A <strong>mediator</strong> lies <em>on</em> the causal pathway between exposure and outcome:</p>
<pre class="text"><code>salt intake → blood pressure → stroke</code></pre>
<p>If we are interested in the <strong>total effect</strong> of salt intake on stroke risk, we should <strong>not</strong> adjust for blood pressure, because this would remove part of the genuine effect (the indirect pathway through blood pressure).</p>
<p>If we are specifically interested in the <strong>direct effect</strong> of salt that is not mediated by blood pressure, then adjusting for blood pressure is appropriate, but the interpretation changes.</p>
<p>The key message is that we should adjust for <strong>confounders</strong>, avoid adjusting for <strong>colliders</strong>, and think carefully before adjusting for <strong>mediators</strong>. DAGs help us to reason about which variables fall into which category.</p>
</section>
<section id="example-of-mediation-salt-sbp-and-incident-cvd" class="level3" data-number="0.6.3">
<h3 data-number="0.6.3" class="anchored" data-anchor-id="example-of-mediation-salt-sbp-and-incident-cvd"><span class="header-section-number">0.6.3</span> 5.3 Example of mediation: salt, SBP, and incident CVD</h3>
<p>We return to the example of salt intake and CVD, now focusing on <strong>mediation</strong>.</p>
<ul>
<li><strong>Exposure</strong>: <code>salt_g_d</code> (daily salt intake).</li>
<li><strong>Mediator</strong>: <code>SBP</code> (systolic blood pressure).</li>
<li><strong>Outcome</strong>: <code>CVD_incident</code>.</li>
</ul>
<p>A simple DAG is:</p>
<pre class="text"><code>salt_g_d  →  SBP  →  CVD_incident</code></pre>
<p>Salt has a modest direct effect on CVD in the data generator, but the main pathway is through <strong>raising SBP</strong>. We compare two models:</p>
<ol type="1">
<li><code>CVD_incident ~ salt_g_d</code> (total effect: salt → CVD, including via SBP)</li>
<li><code>CVD_incident ~ salt_g_d + SBP</code> (direct effect: salt → CVD, <em>holding SBP constant</em>)</li>
</ol>
<p>By comparing the odds ratios for <code>salt_g_d</code> in these two models, we can see how adjusting for a mediator changes the estimand.</p>
<div id="mediator_salt_models_fb2nep_7" class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">"""Mediation example: salt_g_d → SBP → CVD_incident."""</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>OUTCOME_SALT <span class="op">=</span> <span class="st">"CVD_incident"</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>EXPOSURE_SALT <span class="op">=</span> <span class="st">"salt_g_d"</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>MEDIATOR_SBP <span class="op">=</span> <span class="st">"SBP"</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> v <span class="kw">in</span> [OUTCOME_SALT, EXPOSURE_SALT, MEDIATOR_SBP]:</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> v <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">KeyError</span>(<span class="ss">f"Variable '</span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">' not found in df."</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>df_salt <span class="op">=</span> df[[OUTCOME_SALT, EXPOSURE_SALT, MEDIATOR_SBP]].dropna().copy()</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Complete-case sample size: </span><span class="sc">{</span>df_salt<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> observations</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Crude (total-effect-oriented) model</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>m_salt_crude <span class="op">=</span> smf.logit(<span class="ss">f"</span><span class="sc">{</span>OUTCOME_SALT<span class="sc">}</span><span class="ss"> ~ </span><span class="sc">{</span>EXPOSURE_SALT<span class="sc">}</span><span class="ss">"</span>, data<span class="op">=</span>df_salt).fit(disp<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co"># SBP-adjusted (direct-effect-oriented) model</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>m_salt_adj <span class="op">=</span> smf.logit(</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"</span><span class="sc">{</span>OUTCOME_SALT<span class="sc">}</span><span class="ss"> ~ </span><span class="sc">{</span>EXPOSURE_SALT<span class="sc">}</span><span class="ss"> + </span><span class="sc">{</span>MEDIATOR_SBP<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>df_salt</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>).fit(disp<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>rows_salt <span class="op">=</span> []</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>rows_salt.append(</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    summarise_logit_coef(</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>        m_salt_crude,</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>        var_name<span class="op">=</span>EXPOSURE_SALT,</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">"Crude model (CVD_incident ~ salt_g_d)"</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>rows_salt.append(</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    summarise_logit_coef(</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>        m_salt_adj,</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>        var_name<span class="op">=</span>EXPOSURE_SALT,</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">"SBP-adjusted model (CVD_incident ~ salt_g_d + SBP)"</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>summary_salt_med <span class="op">=</span> pd.DataFrame(rows_salt)</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Salt intake and incident CVD: crude vs SBP-adjusted models</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>display(summary_salt_med.<span class="bu">round</span>(<span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="interpreting-the-mediation-example-salt-and-sbp" class="level3" data-number="0.6.4">
<h3 data-number="0.6.4" class="anchored" data-anchor-id="interpreting-the-mediation-example-salt-and-sbp"><span class="header-section-number">0.6.4</span> Interpreting the mediation example (salt and SBP)</h3>
<p>In this synthetic dataset you will typically find that:</p>
<ul>
<li>The <strong>crude OR</strong> for <code>salt_g_d</code> is close to 1 (weak or no association).</li>
<li>The <strong>SBP-adjusted OR</strong> is also close to 1, sometimes slightly below or above.</li>
</ul>
<p>This reflects how the data generator was constructed:</p>
<ul>
<li>Salt has a <strong>small direct effect</strong> on CVD.</li>
<li>Most of the effect of salt operates through <strong>SBP</strong>.</li>
<li>When we adjust for SBP, we remove the mediation pathway and focus on the direct effect.</li>
</ul>
<p>Even though the numerical effect is small, the example illustrates the key conceptual point:</p>
<ul>
<li>If our target is the <strong>total effect</strong> of salt on CVD, we should <em>not</em> adjust for SBP.</li>
<li>If our target is the <strong>direct effect</strong> of salt, holding SBP constant, then we should adjust for SBP, but we must interpret the result as a direct effect.</li>
</ul>
<p>This is different from the confounding example with <code>SES_class</code>, where adjustment reduces bias in estimating the causal effect of physical activity on CVD.</p>
</section>
<section id="predicted-probability-of-incident-cvd-across-salt-intake" class="level3" data-number="0.6.5">
<h3 data-number="0.6.5" class="anchored" data-anchor-id="predicted-probability-of-incident-cvd-across-salt-intake"><span class="header-section-number">0.6.5</span> 5.4 Predicted probability of incident CVD across salt intake</h3>
<p>To make the mediation example more concrete, we can translate the SBP-adjusted logistic model into <strong>predicted probabilities</strong>.</p>
<p>We:</p>
<ul>
<li>Use the SBP-adjusted logistic model.</li>
<li>Fix SBP at a reference value (for example, the median SBP).</li>
<li>Vary daily salt intake (<code>salt_g_d</code>) across its observed range.</li>
<li>Plot the predicted probability of incident CVD.</li>
</ul>
<p>This visualises how the model predicts CVD risk to change with salt intake, <strong>conditional on SBP being held constant</strong>. It emphasises that we are now looking at the <em>direct effect of salt</em>, not the total effect including its influence through SBP.</p>
<div id="mediator_salt_pred_curve_fb2nep_7" class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">"""Predicted probability of incident CVD across salt intake (SBP fixed)."""</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Choose a reference value for SBP (for example, the median)</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>sbp_ref <span class="op">=</span> df_salt[MEDIATOR_SBP].median()</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct a grid of salt values over the central range</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>salt_grid <span class="op">=</span> np.linspace(</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    df_salt[EXPOSURE_SALT].quantile(<span class="fl">0.05</span>),</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    df_salt[EXPOSURE_SALT].quantile(<span class="fl">0.95</span>),</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="dv">100</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>pred_df_salt <span class="op">=</span> pd.DataFrame({</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    EXPOSURE_SALT: salt_grid,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    MEDIATOR_SBP: sbp_ref,</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>pred_df_salt[<span class="st">"p_cvd"</span>] <span class="op">=</span> m_salt_adj.predict(pred_df_salt)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">4</span>))</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>ax.plot(pred_df_salt[EXPOSURE_SALT], pred_df_salt[<span class="st">"p_cvd"</span>], linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Salt intake (g/day)"</span>)</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Predicted probability of incident CVD"</span>)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>ax.set_title(</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Adjusted logistic model: CVD_incident ~ salt_g_d + SBP</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"(SBP fixed at </span><span class="sc">{</span>sbp_ref<span class="sc">:.1f}</span><span class="ss"> mmHg)"</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="interpreting-the-predicted-probability-curve-salt-sbp-fixed" class="level3" data-number="0.6.6">
<h3 data-number="0.6.6" class="anchored" data-anchor-id="interpreting-the-predicted-probability-curve-salt-sbp-fixed"><span class="header-section-number">0.6.6</span> Interpreting the predicted probability curve (salt, SBP fixed)</h3>
<p>In this synthetic dataset the predicted probability curve is typically <strong>almost flat</strong>, with at most a slight upward or downward slope as salt intake increases.</p>
<p>This is expected because:</p>
<ul>
<li>SBP carries most of the effect of salt on CVD in the data generator.</li>
<li>When SBP is fixed at a reference value, we remove the main pathway by which salt influences CVD.</li>
<li>What remains is a small direct effect plus any residual correlation with other variables.</li>
</ul>
<p>The key message is not the exact shape of the curve, but the <strong>change of estimand</strong>:</p>
<ul>
<li>By conditioning on SBP, we are no longer looking at the total effect of salt on CVD, but at the risk pattern <strong>given equal SBP</strong>.</li>
</ul>
<blockquote class="blockquote">
<p>Different models answer different causal questions. Prediction curves are useful for visualising these differences, but they must always be interpreted in the light of the assumed causal structure (here, salt → SBP → CVD).</p>
</blockquote>
</section>
</section>
<section id="interaction-and-effect-modification" class="level2" data-number="0.7">
<h2 data-number="0.7" class="anchored" data-anchor-id="interaction-and-effect-modification"><span class="header-section-number">0.7</span> 6. Interaction and effect modification</h2>
<p>So far we have mainly treated covariates as <strong>confounders</strong>: variables that we adjust for to obtain a less biased estimate of the exposure–outcome association.</p>
<p>Sometimes we are interested in whether the effect of an exposure is <strong>different in different groups</strong>. This is called <strong>effect modification</strong> (or interaction).</p>
<p>Examples in nutritional epidemiology include:</p>
<ul>
<li>Does the association between <strong>physical activity</strong> and CVD differ by <strong>SES</strong>?</li>
<li>Is the association between <strong>salt intake</strong> and CVD stronger in people with <strong>pre-existing hypertension</strong>?</li>
<li>Does the association between <strong>alcohol</strong> and outcomes differ between <strong>men and women</strong>?</li>
</ul>
<p>In a regression model, we can represent effect modification using an <strong>interaction term</strong>. In a logistic regression model:</p>
<p><span class="math display">\[
\log\left(\frac{P(Y=1)}{P(Y=0)}\right)
  = \beta_0 + \beta_1 X_{\text{PA}} + \beta_2 X_{\text{SES}} + \beta_3 (X_{\text{PA}} \times X_{\text{SES}}),
\]</span></p>
<p>where, for example:</p>
<ul>
<li>$ X_{} $ is an indicator of <strong>high physical activity</strong> (<code>highPA</code>).</li>
<li>$ X_{} $ is an indicator of <strong>C2DE</strong> vs <strong>ABC1</strong>.</li>
</ul>
<p>Then:</p>
<ul>
<li>$ _1 $ describes the log-odds ratio for high vs non-high physical activity in the <strong>reference SES group</strong> (for example, ABC1).</li>
<li>$ _1 + _3 $ describes the log-odds ratio for high vs non-high physical activity in the <strong>other SES group</strong> (for example, C2DE).</li>
<li>$ _3 $ itself is the <strong>difference</strong> in log-odds ratios between SES groups.</li>
</ul>
<p>If $ _3 = 0 $, then the effect of physical activity on CVD is the same in both SES groups (on the <strong>odds ratio</strong> scale). If (_3 ), there is multiplicative interaction between physical activity and SES.</p>
<p>In practice we often:</p>
<ol type="1">
<li>Fit a model <strong>with</strong> an interaction term.</li>
<li>Derive and report the <strong>group-specific odds ratios</strong>.</li>
<li>Test the interaction term (for example, using a Wald test).</li>
</ol>
<p>Below we extend the earlier physical activity–SES example by adding an interaction term and computing SES-specific odds ratios for high physical activity.</p>
<div id="3622f40c" class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Interaction between physical activity and SES (highPA × SES_class)</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># We reuse the df_pa dataset defined earlier:</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># - OUTCOME_VAR = "CVD_incident"</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># - EXPOSURE_RAW = "physical_activity" (used to define highPA)</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># - CONF_VAR     = "SES_class" (ABC1 / C2DE)</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co"># The model is:</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     CVD_incident ~ highPA * C(SES_class)</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co"># This allows the association between high physical activity and CVD to differ</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co"># between SES groups.</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Safety check: ensure df_pa and required variables exist</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>required_cols <span class="op">=</span> {OUTCOME_VAR, <span class="st">"highPA"</span>, CONF_VAR}</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>missing_cols <span class="op">=</span> required_cols.difference(df_pa.columns)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> missing_cols:</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">KeyError</span>(</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"The following required columns are missing from df_pa: </span><span class="sc">{</span>missing_cols<span class="sc">}</span><span class="ss">. "</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Please run the earlier confounding example cell first."</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit logistic regression model with interaction term</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>formula_int <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>OUTCOME_VAR<span class="sc">}</span><span class="ss"> ~ highPA * C(</span><span class="sc">{</span>CONF_VAR<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>m_int <span class="op">=</span> smf.logit(formula_int, data<span class="op">=</span>df_pa).fit(disp<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Logistic model with interaction: "</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>OUTCOME_VAR<span class="sc">}</span><span class="ss"> ~ highPA * C(</span><span class="sc">{</span>CONF_VAR<span class="sc">}</span><span class="ss">)</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract coefficients and covariance matrix</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>params <span class="op">=</span> m_int.params</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>cov <span class="op">=</span> m_int.cov_params()</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a><span class="co"># SES levels (we assume a binary SES variable here)</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>ses_levels <span class="op">=</span> <span class="bu">sorted</span>(df_pa[CONF_VAR].dropna().unique())</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(ses_levels) <span class="op">!=</span> <span class="dv">2</span>:</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"This example assumes exactly two </span><span class="sc">{</span>CONF_VAR<span class="sc">}</span><span class="ss"> levels; found: </span><span class="sc">{</span>ses_levels<span class="sc">}</span><span class="ss">."</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>ref_ses <span class="op">=</span> ses_levels[<span class="dv">0</span>]   <span class="co"># reference level used by C(SES_class)</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>other_ses <span class="op">=</span> ses_levels[<span class="dv">1</span>]</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>interaction_term <span class="op">=</span> <span class="ss">f"highPA:C(</span><span class="sc">{</span>CONF_VAR<span class="sc">}</span><span class="ss">)[T.</span><span class="sc">{</span>other_ses<span class="sc">}</span><span class="ss">]"</span></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> interaction_term <span class="kw">not</span> <span class="kw">in</span> params.index:</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">KeyError</span>(</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"Could not find interaction term '</span><span class="sc">{</span>interaction_term<span class="sc">}</span><span class="ss">' in model parameters.</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"Available parameters: </span><span class="sc">{</span><span class="bu">list</span>(params.index)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>rows <span class="op">=</span> []</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Reference SES group (e.g. ABC1): uses the main highPA coefficient</span></span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>    beta_ref,</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>    ci_l_ref,</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>    ci_u_ref,</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>    p_ref,</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>    OR_ref,</span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>    OR_l_ref,</span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>    OR_u_ref,</span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>) <span class="op">=</span> or_from_linear_combination(</span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>    coeff_names<span class="op">=</span>[<span class="st">"highPA"</span>],</span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>    weights<span class="op">=</span>[<span class="fl">1.0</span>],</span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>    params<span class="op">=</span>params,</span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>    cov<span class="op">=</span>cov,</span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>rows.append(</span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>        <span class="st">"SES_class"</span>: ref_ses,</span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a>        <span class="st">"beta"</span>: beta_ref,</span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ci_lower"</span>: ci_l_ref,</span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ci_upper"</span>: ci_u_ref,</span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a>        <span class="st">"p_value"</span>: p_ref,</span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a>        <span class="st">"OR"</span>: OR_ref,</span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a>        <span class="st">"OR_ci_lower"</span>: OR_l_ref,</span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>        <span class="st">"OR_ci_upper"</span>: OR_u_ref,</span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a>        <span class="st">"note"</span>: <span class="st">"Reference SES group (no interaction term added)"</span>,</span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Other SES group (e.g. C2DE): main effect + interaction term</span></span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a>    beta_other,</span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a>    ci_l_other,</span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a>    ci_u_other,</span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a>    p_other,</span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a>    OR_other,</span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a>    OR_l_other,</span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a>    OR_u_other,</span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a>) <span class="op">=</span> or_from_linear_combination(</span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a>    coeff_names<span class="op">=</span>[<span class="st">"highPA"</span>, interaction_term],</span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a>    weights<span class="op">=</span>[<span class="fl">1.0</span>, <span class="fl">1.0</span>],</span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a>    params<span class="op">=</span>params,</span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true" tabindex="-1"></a>    cov<span class="op">=</span>cov,</span>
<span id="cb12-98"><a href="#cb12-98" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-99"><a href="#cb12-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-100"><a href="#cb12-100" aria-hidden="true" tabindex="-1"></a>rows.append(</span>
<span id="cb12-101"><a href="#cb12-101" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb12-102"><a href="#cb12-102" aria-hidden="true" tabindex="-1"></a>        <span class="st">"SES_class"</span>: other_ses,</span>
<span id="cb12-103"><a href="#cb12-103" aria-hidden="true" tabindex="-1"></a>        <span class="st">"beta"</span>: beta_other,</span>
<span id="cb12-104"><a href="#cb12-104" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ci_lower"</span>: ci_l_other,</span>
<span id="cb12-105"><a href="#cb12-105" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ci_upper"</span>: ci_u_other,</span>
<span id="cb12-106"><a href="#cb12-106" aria-hidden="true" tabindex="-1"></a>        <span class="st">"p_value"</span>: p_other,</span>
<span id="cb12-107"><a href="#cb12-107" aria-hidden="true" tabindex="-1"></a>        <span class="st">"OR"</span>: OR_other,</span>
<span id="cb12-108"><a href="#cb12-108" aria-hidden="true" tabindex="-1"></a>        <span class="st">"OR_ci_lower"</span>: OR_l_other,</span>
<span id="cb12-109"><a href="#cb12-109" aria-hidden="true" tabindex="-1"></a>        <span class="st">"OR_ci_upper"</span>: OR_u_other,</span>
<span id="cb12-110"><a href="#cb12-110" aria-hidden="true" tabindex="-1"></a>        <span class="st">"note"</span>: <span class="st">"Main effect + interaction term"</span>,</span>
<span id="cb12-111"><a href="#cb12-111" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-112"><a href="#cb12-112" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-113"><a href="#cb12-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-114"><a href="#cb12-114" aria-hidden="true" tabindex="-1"></a>summary_int <span class="op">=</span> pd.DataFrame(rows)</span>
<span id="cb12-115"><a href="#cb12-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-116"><a href="#cb12-116" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) The interaction term itself (difference in log-ORs between SES groups)</span></span>
<span id="cb12-117"><a href="#cb12-117" aria-hidden="true" tabindex="-1"></a>beta_int <span class="op">=</span> params[interaction_term]</span>
<span id="cb12-118"><a href="#cb12-118" aria-hidden="true" tabindex="-1"></a>se_int <span class="op">=</span> np.sqrt(cov.loc[interaction_term, interaction_term])</span>
<span id="cb12-119"><a href="#cb12-119" aria-hidden="true" tabindex="-1"></a>z_crit <span class="op">=</span> <span class="fl">1.96</span></span>
<span id="cb12-120"><a href="#cb12-120" aria-hidden="true" tabindex="-1"></a>ci_l_int <span class="op">=</span> beta_int <span class="op">-</span> z_crit <span class="op">*</span> se_int</span>
<span id="cb12-121"><a href="#cb12-121" aria-hidden="true" tabindex="-1"></a>ci_u_int <span class="op">=</span> beta_int <span class="op">+</span> z_crit <span class="op">*</span> se_int</span>
<span id="cb12-122"><a href="#cb12-122" aria-hidden="true" tabindex="-1"></a><span class="co"># p-value is less central here for teaching, so we skip computing it again</span></span>
<span id="cb12-123"><a href="#cb12-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-124"><a href="#cb12-124" aria-hidden="true" tabindex="-1"></a>interaction_summary <span class="op">=</span> pd.Series(</span>
<span id="cb12-125"><a href="#cb12-125" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb12-126"><a href="#cb12-126" aria-hidden="true" tabindex="-1"></a>        <span class="st">"beta"</span>: beta_int,</span>
<span id="cb12-127"><a href="#cb12-127" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ci_lower"</span>: ci_l_int,</span>
<span id="cb12-128"><a href="#cb12-128" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ci_upper"</span>: ci_u_int,</span>
<span id="cb12-129"><a href="#cb12-129" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb12-130"><a href="#cb12-130" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"highPA × SES_class"</span>,</span>
<span id="cb12-131"><a href="#cb12-131" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-132"><a href="#cb12-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-133"><a href="#cb12-133" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"SES-specific odds ratios for high physical activity "</span></span>
<span id="cb12-134"><a href="#cb12-134" aria-hidden="true" tabindex="-1"></a>      <span class="st">"(from interaction model):</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb12-135"><a href="#cb12-135" aria-hidden="true" tabindex="-1"></a>display(summary_int.<span class="bu">round</span>(<span class="dv">3</span>))</span>
<span id="cb12-136"><a href="#cb12-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-137"><a href="#cb12-137" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="40596ef5" class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Interaction term (difference in log-ORs between SES groups):</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>display(interaction_summary.to_frame().<span class="bu">round</span>(<span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="interpreting-an-interaction-term-in-logistic-regression" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Interpreting an Interaction Term in Logistic Regression</h1>
<section id="high-physical-activity-socio-economic-status" class="level3" data-number="1.0.1">
<h3 data-number="1.0.1" class="anchored" data-anchor-id="high-physical-activity-socio-economic-status"><span class="header-section-number">1.0.1</span> (High Physical Activity × Socio-Economic Status)</h3>
<p>This note explains how to interpret an interaction term in a logistic regression model of the form:</p>
<p><span class="math display">\[
\text{CVD\_incident} \sim \text{highPA} \times \text{SES\_class}.
\]</span></p>
<p>The goal is to give a <strong>generic, reusable explanation</strong> suitable for the workbook, without tying it to any specific numerical results.</p>
<hr>
</section>
<section id="what-an-interaction-term-represents" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="what-an-interaction-term-represents"><span class="header-section-number">1.1</span> 1. What an interaction term represents</h2>
<p>An interaction term allows the effect of an exposure to differ across levels of another variable.</p>
<p>In this model:</p>
<ul>
<li><strong>highPA</strong> captures the association between high physical activity and CVD<br>
<strong>in the reference SES group</strong> (e.g.&nbsp;ABC1).</li>
<li><strong>SES_class</strong> captures the difference in baseline CVD risk between SES groups.</li>
<li><strong>highPA × SES_class</strong> captures whether the association between physical activity and CVD <strong>differs between SES groups</strong>.</li>
</ul>
<p>In other words, the interaction term answers:</p>
<blockquote class="blockquote">
<p><em>Is the association between physical activity and CVD the same in ABC1 and C2DE,<br>
or does it differ?</em></p>
</blockquote>
<hr>
</section>
<section id="how-to-read-the-interaction-coefficient" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="how-to-read-the-interaction-coefficient"><span class="header-section-number">1.2</span> 2. How to read the interaction coefficient</h2>
<p>On the log-odds (logit) scale:</p>
<ul>
<li>A <strong>zero</strong> interaction coefficient means the effect of high physical activity<br>
is the <em>same</em> in both SES groups.</li>
<li>A <strong>positive</strong> coefficient means the association is <em>stronger</em> (more protective or more harmful, depending on direction) in the non-reference SES group.</li>
<li>A <strong>negative</strong> coefficient means the association is <em>weaker</em> in the non-reference SES group.</li>
</ul>
<p>When exponentiated, the interaction coefficient becomes the <strong>ratio of odds ratios</strong>:</p>
<p><span class="math display">\[
\exp(\beta_{\text{interaction}})  
  = \frac{\text{OR(highPA in non-ref SES)}}{\text{OR(highPA in ref SES)}}.
\]</span></p>
<p>Values:</p>
<ul>
<li><strong>= 1</strong> → no difference<br>
</li>
<li><strong>&gt; 1</strong> → stronger association in the non-reference group<br>
</li>
<li><strong>&lt; 1</strong> → weaker association in the non-reference group</li>
</ul>
<hr>
</section>
<section id="how-the-interaction-affects-group-specific-effects" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="how-the-interaction-affects-group-specific-effects"><span class="header-section-number">1.3</span> 3. How the interaction affects group-specific effects</h2>
<p>The model estimates:</p>
<ul>
<li><p>Effect of highPA in the <strong>reference</strong> SES group:<br>
<span class="math display">\[
\beta_{\text{highPA}}.
\]</span></p></li>
<li><p>Effect of highPA in the <strong>other</strong> SES group:<br>
<span class="math display">\[
\beta_{\text{highPA}} + \beta_{\text{interaction}}.
\]</span></p></li>
</ul>
<p>Thus the interaction term determines how much the highPA effect <strong>changes</strong> between SES strata.</p>
<p>This is the key reason we need the interaction term: without it, the model assumes the effect is identical in all SES groups.</p>
<hr>
</section>
<section id="confidence-intervals-and-interpretation" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="confidence-intervals-and-interpretation"><span class="header-section-number">1.4</span> 4. Confidence intervals and interpretation</h2>
<p>When interpreting an interaction:</p>
<ul>
<li>A confidence interval that <strong>includes zero</strong> (on the log scale) or <strong>includes 1</strong> (on the OR scale) implies that the data are <strong>compatible with no interaction</strong>.</li>
<li>Interaction terms typically require <strong>large samples</strong> to detect modest differences.</li>
<li>Absence of statistical evidence for interaction does <strong>not</strong> prove the effects are identical; it simply indicates we cannot conclude they differ.</li>
</ul>
<p>For teaching purposes:<br>
<em>Interactions are often noisier and harder to estimate than main effects. This is normal and not a sign of a mistake.</em></p>
<hr>
</section>
<section id="practical-takeaway-for-applied-epidemiology" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="practical-takeaway-for-applied-epidemiology"><span class="header-section-number">1.5</span> 5. Practical takeaway for applied epidemiology</h2>
<p>When students encounter an interaction term:</p>
<ol type="1">
<li>Identify which group is the <strong>reference</strong> for SES.<br>
</li>
<li>Interpret the main effect of highPA as applying to that reference group.<br>
</li>
<li>Add the interaction term to obtain the effect in the other SES group.<br>
</li>
<li>Use the confidence interval of the interaction to judge whether a <strong>meaningful difference</strong> between groups is supported by the data.<br>
</li>
<li>Avoid over-interpreting small, non-significant interactions.</li>
</ol>
<p>In nutritional epidemiology it is common to <em>test</em> for effect modification but rare to <em>find</em> strong evidence unless the effect truly differs across groups or the study is very large.</p>
<hr>
<p>If you’d like, I can also prepare a short “student-friendly” sidebar version for the workbook margins, or add an optional visual explaining interaction on the logit and OR scales.</p>
</section>
<section id="counterfactuals" class="level2" data-number="1.6">
<h2 data-number="1.6" class="anchored" data-anchor-id="counterfactuals"><span class="header-section-number">1.6</span> 7. Counterfactuals</h2>
<p>Modern causal inference often uses <strong>counterfactual</strong> or <strong>potential outcome</strong> language. For each individual we imagine:</p>
<ul>
<li>$ Y(1) $: the outcome that would occur if the individual were exposed.</li>
<li>$ Y(0) $: the outcome that would occur if the same individual were not exposed.</li>
</ul>
<p>The <strong>causal effect</strong> for that individual is the (usually unobservable) difference $ Y(1) - Y(0) $. In practice we cannot observe both outcomes for the same person, so we rely on comparisons between groups, together with assumptions about confounding, measurement, and model specification.</p>
<p>Adjustment strategies (for example, regression with appropriate covariates based on a sensible DAG) are used to make the exposed and unexposed groups more comparable, so that the difference in observed outcomes approximates the difference between counterfactual outcomes.</p>
<p>Workbook 9 returns to these ideas and introduces more formal notation and methods for estimating causal effects under explicit assumptions.</p>
</section>
<section id="reflection-and-exercises" class="level2" data-number="1.7">
<h2 data-number="1.7" class="anchored" data-anchor-id="reflection-and-exercises"><span class="header-section-number">1.7</span> Reflection and exercises</h2>
<ol type="1">
<li><p><strong>Draw a DAG</strong> for the association between red meat intake and incident cancer in the FB2NEP cohort. Include at least age, sex, SES_class, IMD_quintile, smoking_status, and family history. Identify plausible confounders, colliders, and mediators.</p></li>
<li><p><strong>Confounders in practice</strong>: Choose a different exposure (for example, <code>fruit_veg_g_d</code> or <code>salt_g_d</code>) and a relevant outcome. Propose at least two variables as potential confounders based on subject-matter knowledge. Fit crude and adjusted models and compare the estimates.</p></li>
<li><p><strong>Energy adjustment</strong>: Using <code>energy_kcal</code> and a nutrient of your choice (for example, <code>fibre_g_d</code>), implement the nutrient density method and the residual method. Compare the associations with BMI or another suitable outcome for the raw, density-based, and residual-based exposures.</p></li>
<li><p><strong>Collider bias</strong>: Modify the collider simulation to use a different collider (for example, an indicator of study participation) and show how conditioning on participation can induce associations between variables that are otherwise independent.</p></li>
<li><p><strong>Mediators</strong>: For a hypothetical causal chain in nutrition (for example, <code>diet quality → BMI → blood pressure → CVD</code>), decide which variables you would adjust for when estimating the total effect of diet quality on CVD, and which you would <em>not</em> adjust for. Explain your reasoning.</p></li>
<li><p><strong>Counterfactual thinking</strong>: In your own words, describe what it would mean to say that “reducing salt intake by 2 g/day would reduce average SBP by 5 mmHg” in terms of potential outcomes. What assumptions would be needed for this statement to be interpreted causally in an observational study?</p></li>
</ol>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/ggkuhnle\.github\.io\/fb2nep-epi\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© University of Reading 2025 · Licensed <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/ggkuhnle/fb2nep-epi/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li><li><a href="https://github.com/ggkuhnle/fb2nep-epi/blob/main/notebooks/1.09_regression_modelling_02.ipynb" class="toc-action"><i class="bi empty"></i>View source</a></li></ul></div></div>
    <div class="nav-footer-right">
<p>Built with Quarto</p>
</div>
  </div>
</footer>




<script src="../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>